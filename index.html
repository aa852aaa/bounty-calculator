<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ’²å…‹è³é‡‘è¨ˆç®—æ©Ÿ</title>
</head>
<body>
  <h1>æ’²å…‹è³é‡‘è¨ˆç®—æ©Ÿ</h1>

  <label for="modeSelect">é¸æ“‡æ¯”è³½æ¨¡å¼ï¼š</label>
  <select id="modeSelect" onchange="updateModeForm()">
    <option value="KO">KO</option>
    <option value="PKO">PKO</option>
    <option value="Mystery">Mystery</option>
  </select><br><br>

  <label>èµ·å§‹ç±Œç¢¼ï¼š</label>
  <input type="number" id="startingChips" placeholder="ä¾‹å¦‚ 30000"><br><br>

  <label>ç¸½äººæ•¸ï¼š</label>
  <input type="number" id="totalPlayers" placeholder="ä¾‹å¦‚ 331"><br><br>

  <label>ç›®å‰å‰©é¤˜äººæ•¸ï¼š</label>
  <input type="number" id="remainingPlayers" placeholder="ä¾‹å¦‚ 5"><br><br>

  <label>åæ¬¡çé‡‘çµæ§‹ï¼ˆæ ¼å¼ï¼šåæ¬¡:é‡‘é¡ï¼Œæ¯è¡Œä¸€ç­†ï¼Œå¯ç•¥éåæ¬¡ï¼Œæœƒæ²¿ç”¨ä¸Šä¸€ç­†é‡‘é¡ï¼›æœ€å¾Œä¸€ç­†åæ¬¡ä¹‹å¾Œé è¨­ç‚º0ï¼‰ï¼š</label><br>
  <textarea id="payoutStructure" rows="10" cols="30" placeholder="1:20333
2:15247
4:8574"></textarea><br><br>

  <div id="modeSpecificInputs"></div>

  <button onclick="processInputs()">è¨ˆç®—</button>

  <h2>ğŸ” çµæœï¼š</h2>
  <pre id="output"></pre>

  <script>
    function updateModeForm() {
      const mode = document.getElementById("modeSelect").value;
      const container = document.getElementById("modeSpecificInputs");
      container.innerHTML = "";

      if (mode === "KO") {
        container.innerHTML = `
          <label>å–®ç­†è³é‡‘é‡‘é¡ï¼š</label>
          <input type="number" id="koBounty"><br><br>
        `;
      } else if (mode === "PKO") {
        container.innerHTML = `
          <label>å³æ™‚é ˜å–è³é‡‘é‡‘é¡ï¼š</label>
          <input type="number" id="pkoTarget"><br><br>
          <label>æœ¬æ¡Œç¸½è³é‡‘ï¼ˆç”¨ä¾†å¹³å‡ä¸¦è¨ˆç®—å‰©é¤˜è³é‡‘ï¼‰ï¼š</label>
          <input type="number" id="pkoTotalBounty"><br><br>
          <label>æœ¬æ¡Œç¸½äººæ•¸ï¼ˆç”¨ä¾†å¹³å‡ä¸¦è¨ˆç®—å‰©é¤˜è³é‡‘ï¼‰ï¼š</label>
          <input type="number" id="pkoPlayers"><br><br>
        `;
      } else if (mode === "Mystery") {
        container.innerHTML = `
          <label>Mysteryè³é‡‘çµæ§‹ï¼ˆæ ¼å¼ï¼šé‡‘é¡:å‰©é¤˜æ•¸é‡ï¼Œæ¯è¡Œä¸€ç­†ï¼‰ï¼š</label><br>
          <textarea id="mysteryStructure" rows="10" cols="30" placeholder="26000:1\n15179:1\n6600:1"></textarea><br><br>
        `;
      }
    }

    function processInputs() {
      const mode = document.getElementById("modeSelect").value;
      const startingChips = parseFloat(document.getElementById("startingChips").value);
      const totalPlayers = parseInt(document.getElementById("totalPlayers").value);
      const remainingPlayers = parseInt(document.getElementById("remainingPlayers").value);
      const payoutText = document.getElementById("payoutStructure").value;

      let rawPayouts = [];
      payoutText.split('\n').forEach(line => {
        const [place, amount] = line.split(':');
        if (place && amount) {
          const rank = parseInt(place.trim());
          const money = parseFloat(amount.replace(/,/g, '').trim());
          rawPayouts.push({ rank, money });
        }
      });
      rawPayouts.sort((a, b) => a.rank - b.rank);
      let payouts = {}, lastAmount = 0, current = 1;
      for (let i = 0; i < rawPayouts.length; i++) {
        const { rank, money } = rawPayouts[i];
        while (current < rank) {
          payouts[current] = lastAmount;
          current++;
        }
        payouts[rank] = money;
        lastAmount = money;
        current = rank + 1;
      }
      while (current <= totalPlayers) {
        payouts[current] = 0;
        current++;
      }

      let locked = payouts[remainingPlayers] || 0;
      let remainingPrize = 0;
      for (let i = 1; i <= remainingPlayers; i++) remainingPrize += payouts[i];
      let dynamicPrize = remainingPrize - locked * remainingPlayers;

      let bountyAvg = 0;
      if (mode === "KO") {
        bountyAvg = parseFloat(document.getElementById("koBounty").value);
      } else if (mode === "PKO") {
        const totalBounty = parseFloat(document.getElementById("pkoTotalBounty").value);
        const tablePlayers = parseInt(document.getElementById("pkoPlayers").value);
        bountyAvg = totalBounty / tablePlayers;
      } else if (mode === "Mystery") {
        const lines = document.getElementById("mysteryStructure").value.split('\n');
        let total = 0, count = 0;
        lines.forEach(line => {
          const [amt, qty] = line.split(':');
          if (amt && qty) {
            const val = parseFloat(amt.replace(/,/g, ''));
            const q = parseInt(qty);
            total += val * q;
            count += q;
          }
        });
        bountyAvg = total / count;
      }

      const bountyPool = bountyAvg * remainingPlayers;
      const totalChips = startingChips * totalPlayers;
      const totalPool = dynamicPrize + bountyPool;
      const bountyPower = totalChips / totalPool;

      let bountyValue = 0;
      if (mode === "KO") bountyValue = bountyAvg * bountyPower;
      else if (mode === "PKO") bountyValue = parseFloat(document.getElementById("pkoTarget").value) * bountyPower;
      else if (mode === "Mystery") bountyValue = bountyAvg * bountyPower;

      let result = `ç¸½ç±Œç¢¼ï¼š${totalChips.toFixed(0)}\n`;
      result += `å‰©é¤˜åæ¬¡çé‡‘ï¼š${dynamicPrize.toFixed(2)}\n`;
      result += `å‰©é¤˜ç¸½è³é‡‘çæ± ï¼š${bountyPool.toFixed(2)}\n`;
      result += `ç¸½å‰©é¤˜çæ± ï¼š${totalPool.toFixed(2)}\n`;
      result += `è³é‡‘åŠ›é‡ï¼ˆæ¯å–®ä½å¯å…Œæ›ç±Œç¢¼ï¼‰ï¼š${bountyPower.toFixed(4)}\n`;
      result += `å³æ™‚è³é‡‘åƒ¹å€¼ç±Œç¢¼ï¼š${bountyValue.toFixed(2)}`;

      document.getElementById("output").innerText = result;
    }

    window.onload = updateModeForm;
  </script>
</body>
</html>
